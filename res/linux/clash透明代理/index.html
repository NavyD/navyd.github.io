<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title> - Even - A super concise theme for Hugo</title>
<meta name=renderer content="webkit">
<meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1">
<meta http-equiv=cache-control content="no-transform">
<meta http-equiv=cache-control content="no-siteapp">
<meta name=theme-color content="#f8f5ec">
<meta name=msapplication-navbutton-color content="#f8f5ec">
<meta name=apple-mobile-web-app-capable content="yes">
<meta name=apple-mobile-web-app-status-bar-style content="#f8f5ec">
<meta name=author content="navyd"><meta name=description content="clash Linux透明代理原理 参考： Linux transparent proxy support Linux transparent proxy support github 透明代理 UDP 为什么要用 TProxy？ 透明代理的基本原理 从 ss-redir 的实现到 Linux NAT 相关工具 配置文件 fake"><meta name=keywords content="Hugo,blog,navyd">
<meta name=generator content="Hugo 0.87.0 with theme even">
<link rel=canonical href=https://navyd.github.io/res/linux/clash%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86/>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/manifest.json>
<link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5>
<link href=/sass/main.min.a659bb31b17a54f7792e1bc783fc75b31118e6a175b42337b03fae0b1a3ef2b5.css rel=stylesheet>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin=anonymous>
<meta property="og:title" content>
<meta property="og:description" content="clash Linux透明代理原理 参考： Linux transparent proxy support Linux transparent proxy support github 透明代理 UDP 为什么要用 TProxy？ 透明代理的基本原理 从 ss-redir 的实现到 Linux NAT 相关工具 配置文件 fake">
<meta property="og:type" content="article">
<meta property="og:url" content="https://navyd.github.io/res/linux/clash%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86/"><meta property="article:section" content="res">
<meta itemprop=name content>
<meta itemprop=description content="clash Linux透明代理原理 参考： Linux transparent proxy support Linux transparent proxy support github 透明代理 UDP 为什么要用 TProxy？ 透明代理的基本原理 从 ss-redir 的实现到 Linux NAT 相关工具 配置文件 fake">
<meta itemprop=wordCount content="2280">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content>
<meta name=twitter:description content="clash Linux透明代理原理 参考： Linux transparent proxy support Linux transparent proxy support github 透明代理 UDP 为什么要用 TProxy？ 透明代理的基本原理 从 ss-redir 的实现到 Linux NAT 相关工具 配置文件 fake"><!--[if lte IE 9]><script src=https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js></script><![endif]--><!--[if lt IE 9]><script src=https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js></script>
<script src=https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js></script><![endif]-->
</head>
<body>
<div id=mobile-navbar class=mobile-navbar>
<div class=mobile-header-logo>
<a href=/ class=logo>navyd的个人博客</a>
</div>
<div class=mobile-navbar-icon>
<span></span>
<span></span>
<span></span>
</div>
</div>
<nav id=mobile-menu class="mobile-menu slideout-menu">
<ul class=mobile-menu-list>
<a href=/>
<li class=mobile-menu-item>Home</li>
</a><a href=/post/>
<li class=mobile-menu-item>Archives</li>
</a><a href=/tags/>
<li class=mobile-menu-item>Tags</li>
</a><a href=/categories/>
<li class=mobile-menu-item>Categories</li>
</a>
</ul>
</nav>
<div class=container id=mobile-panel>
<header id=header class=header>
<div class=logo-wrapper>
<a href=/ class=logo>navyd的个人博客</a>
</div>
<nav class=site-navbar>
<ul id=menu class=menu>
<li class=menu-item>
<a class=menu-item-link href=/>Home</a>
</li><li class=menu-item>
<a class=menu-item-link href=/post/>Archives</a>
</li><li class=menu-item>
<a class=menu-item-link href=/tags/>Tags</a>
</li><li class=menu-item>
<a class=menu-item-link href=/categories/>Categories</a>
</li>
</ul>
</nav>
</header>
<main id=main class=main>
<div class=content-wrapper>
<div id=content class=content>
<article class=post>
<div class=post-content>
<h1 id=clash>clash</h1>
<h2 id=linux透明代理原理>Linux透明代理原理</h2>
<p>参考：</p>
<ul>
<li><a test href=https://powerdns.org/tproxydoc/tproxy.md.html>Linux transparent proxy support</a></li>
<li><a test href=https://github.com/ahupowerdns/tproxydoc/blob/master/tproxy.md>Linux transparent proxy support github</a></li>
<li><a test href=https://www.codenong.com/js5393fb5e2c87/>透明代理 UDP 为什么要用 TProxy？</a></li>
<li><a test href=https://github.com/lazytiger/trojan-rs/blob/master/PRINCIPLE.md>透明代理的基本原理</a></li>
<li><a test href=https://vvl.me/2018/06/from-ss-redir-to-linux-nat/>从 ss-redir 的实现到 Linux NAT</a></li>
</ul>
<h2 id=相关工具>相关工具</h2>
<h3 id=配置文件>配置文件</h3>
<ul>
<li><a test href=https://cdn.jsdelivr.net/gh/Hackl0us/SS-Rule-Snippet@master/LAZY_RULES/clash.yaml>fake-ip-filter规则</a></li>
<li><a test href=https://github.com/ACL4SSR/ACL4SSR/tree/master/Clash>ACL4SSR 分流规则</a></li>
<li><a test href=https://github.com/Loyalsoldier/clash-rules>clash-rules Clash Premium Provider可直接使用</a></li>
</ul>
<p>相关项目参考：</p>
<ul>
<li><a test href=https://github.com/Hackl0us/SS-Rule-Snippet>SS-Rule-Snippet</a></li>
<li><a test href=https://github.com/ACL4SSR/ACL4SSR/tree/master>SSR去广告规则/GFWList规则/Clash规则碎片</a></li>
<li><a test href=https://github.com/Loyalsoldier/clash-rules>clash-rules</a></li>
</ul>
<h3 id=订阅转换subconverter>订阅转换subconverter</h3>
<p>clash提供<a test href=https://lancellc.gitbook.io/clash/clash-config-file/proxy-provider>Proxy Provider</a>功能，可以方便的分离代理节点为单个url资源，自动更新订阅节点等如：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=c>#port: 8888</span><span class=w>
</span><span class=w></span><span class=c>#socks-port: 8889</span><span class=w>
</span><span class=w></span><span class=c># ...</span><span class=w>
</span><span class=w></span><span class=c># proxy provider start here</span><span class=w>
</span><span class=w></span><span class=nt>proxy-providers</span><span class=p>:</span><span class=w>
</span><span class=w>  </span><span class=nt>hk</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>http</span><span class=w>
</span><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>./hk.yaml</span><span class=w>
</span><span class=w>    </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://remote.lancelinked.icu/files/hk.yaml</span><span class=w>
</span><span class=w>    </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>3600</span><span class=w>
</span><span class=w>    </span><span class=nt>health-check</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://www.gstatic.com/generate_204</span><span class=w>
</span><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>
</span><span class=w>  </span><span class=nt>us</span><span class=p>:</span><span class=w>
</span><span class=w>    </span><span class=nt>type</span><span class=p>:</span><span class=w> </span><span class=l>file</span><span class=w>
</span><span class=w>    </span><span class=nt>path</span><span class=p>:</span><span class=w> </span><span class=l>/home/lance/.clash/provider/us.yaml</span><span class=w>
</span><span class=w>    </span><span class=nt>health-check</span><span class=p>:</span><span class=w>
</span><span class=w>      </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span><span class=w>      </span><span class=nt>url</span><span class=p>:</span><span class=w> </span><span class=l>http://www.gstatic.com/generate_204</span><span class=w>
</span><span class=w>      </span><span class=nt>interval</span><span class=p>:</span><span class=w> </span><span class=m>300</span><span class=w>
</span><span class=w></span><span class=c># proxy provider end</span><span class=w>
</span><span class=w>
</span><span class=w></span><span class=c>#Proxy:</span><span class=w>
</span><span class=w></span><span class=c>#  - type: socks5</span><span class=w>
</span><span class=w></span><span class=c>#    name: spck</span><span class=w>
</span><span class=w></span><span class=c>#    port: 34335</span><span class=w>
</span><span class=w></span><span class=c>#    server: 127.0.0.1</span><span class=w>
</span><span class=w></span><span class=c>#    udp: true</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>在使用机场提供的clash文件时通常只会使用到其中的proxies，还有过滤节点等需求，clash不支持过滤节点。而<a test href=https://github.com/tindy2013/subconverter/blob/master/README-cn.md#%E8%AF%B4%E6%98%8E%E7%9B%AE%E5%BD%95>subconverter</a>提供了订阅转换与过滤等必要的功能</p>
<h4 id=docker部署>docker部署</h4>
<p>使用docker安装</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-sh data-lang=sh>docker run -d --restart<span class=o>=</span>always -p 25500:25500 tindy2013/subconverter:latest
</code></pre></td></tr></table>
</div>
</div><p>subconverter参数：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback>target=clash	# 转换结果为 clash 配置
url=xxx	# 机场订阅链接
include=(TW|台湾|台灣)	# 只匹配台湾节点
list=true	# 生成 provider 链接

# 将urlencoded 参数拼接起来得到新的订阅链接——只包含台湾节点的 provider 链接
https://localhost:25500/sub?target=clash&amp;url=https%3a%2f%2fnfnf.xyz%2flink%2fabcdefg%3fmu%3d4&amp;include=(TW%7c%e5%8f%b0%e6%b9%be%7c%e5%8f%b0%e7%81%a3)&amp;list=true
</code></pre></td></tr></table>
</div>
</div><p>参考：</p>
<ul>
<li><a test href=https://10101.io/2020/02/12/use-clash-proxy-provider-with-subconverter>Clash proxy-provider 搭配 subconverter 使用小记</a></li>
</ul>
<h2 id=docker部署-1>docker部署</h2>
<p>在docker内启动时使用iptables操作，stop时清理iptables。</p>
<ul>
<li><a test href=https://hub.docker.com/r/navyd/clash>自用docker镜像</a></li>
<li><a test href=https://github.com/NavyD/docker-clash>NavyD/docker-clash</a></li>
</ul>
<h2 id=代理方式>代理方式</h2>
<h3 id=tcp-redir--udp-tproxy>TCP redir + UDP TPROXY</h3>
<p>redir模式。对转发流量使用tcp redir, udp tproxy方式代理。本机仅代理tcp，支持docker内部代理。支持fakeip但存在icmp无法回应的问题（tcp udp没有问题），tun-fakeip可以提供更好的服务。</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># local </span>
<span class=c1># 接管clash宿主机内部流量</span>
iptables -t nat -N CLASH
iptables -t nat -F CLASH
<span class=c1># private</span>
setup_private nat CLASH
<span class=c1># 过滤本机clash流量 避免循环 user无法使用代理</span>
iptables -t nat -A CLASH -m owner --uid-owner <span class=s2>&#34;</span><span class=nv>$RUNNING_UID</span><span class=s2>&#34;</span> -j RETURN
iptables -t nat -A CLASH -p tcp -j REDIRECT --to-port <span class=s2>&#34;</span><span class=nv>$REDIR_PORT</span><span class=s2>&#34;</span>

iptables -t nat -A OUTPUT -j CLASH

<span class=c1># 转发流量 tcp redir</span>
iptables -t nat -N CLASH_EXTERNAL
iptables -t nat -F CLASH_EXTERNAL
<span class=c1># google dns first</span>
iptables -t nat -A CLASH_EXTERNAL -p tcp -d 8.8.8.8 -j REDIRECT --to-port <span class=s2>&#34;</span><span class=nv>$REDIR_PORT</span><span class=s2>&#34;</span>
iptables -t nat -A CLASH_EXTERNAL -p tcp -d 8.8.4.4 -j REDIRECT --to-port <span class=s2>&#34;</span><span class=nv>$REDIR_PORT</span><span class=s2>&#34;</span>
<span class=c1># private</span>
setup_private nat CLASH_EXTERNAL
<span class=c1># tcp redir</span>
iptables -t nat -A CLASH_EXTERNAL -p tcp -j REDIRECT --to-port <span class=s2>&#34;</span><span class=nv>$REDIR_PORT</span><span class=s2>&#34;</span>

iptables -t nat -A PREROUTING -j CLASH_EXTERNAL

<span class=c1># 转发流量 udp tproxy</span>
iptables -t mangle -N CLASH_EXTERNAL
iptables -t mangle -F CLASH_EXTERNAL
<span class=c1># private</span>
setup_private mangle CLASH_EXTERNAL
<span class=c1># udp tproxy redir</span>
iptables -t mangle -A CLASH_EXTERNAL -p udp -j TPROXY --on-port <span class=s2>&#34;</span><span class=nv>$REDIR_PORT</span><span class=s2>&#34;</span> --tproxy-mark <span class=nv>$MARK_ID</span>

iptables -t mangle -A PREROUTING -j CLASH_EXTERNAL

<span class=c1># route udp</span>
ip rule add fwmark <span class=nv>$MARK_ID</span> table <span class=nv>$TABLE_ID</span>
ip route add <span class=nb>local</span> default dev lo table <span class=nv>$TABLE_ID</span>
</code></pre></td></tr></table>
</div>
</div><p>参考：</p>
<ul>
<li><a test href=https://lancellc.gitbook.io/clash/start-clash/clash-udp-tproxy-support>Clash TProxy Mode</a></li>
<li><a test href=https://github.com/Dreamacro/clash/issues/555#issuecomment-595064646>clash本机做透明代理iptables规则请教</a></li>
<li><a test href=https://github.com/Dreamacro/clash/issues/1047>Fake IP 模式如何直接转发icmp包（无法Ping任何网站）</a></li>
<li><a test href=https://lev.shield.asia/index.php/Ops/31.html>iptables处理icmp转发</a></li>
<li><a test href=https://blog.lilydjwg.me/2018/7/16/transparent-proxy-for-tcp-and-udp-with-iptables.213139.html>使用 iptables 透明代理 TCP 与 UDP</a></li>
</ul>
<h3 id=tcpudp-tproxy>TCP&UDP TPROXY</h3>
<p>clash支持tcp tproxy，可以使用tcp tproxy避免在nat中重定向定义多个chain</p>
<p>在配置文件config.yaml中增加：</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=c># Transparent proxy server port for Linux (TProxy TCP and TProxy UDP)</span><span class=w>
</span><span class=w></span><span class=nt>tproxy-port</span><span class=p>:</span><span class=w> </span><span class=m>7893</span><span class=w>
</span></code></pre></td></tr></table>
</div>
</div><p>本机代理与TCP redir相似，下面是透明代理</p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># ROUTE RULES</span>
ip rule add fwmark <span class=nv>$MARK_ID</span> table <span class=nv>$TABLE_ID</span>
ip route add <span class=nb>local</span> default dev lo table <span class=nv>$TABLE_ID</span>

<span class=c1># CREATE TABLE</span>
iptables -t mangle -N clash

<span class=c1># RETURN LOCAL AND LANS</span>
setup_private mangle clash

<span class=c1># FORWARD ALL</span>
iptables -t mangle -A clash -p udp -j TPROXY --on-port <span class=nv>$REDIR_PORT</span> --tproxy-mark <span class=nv>$MARK_ID</span>
iptables -t mangle -A clash -p tcp -j TPROXY --on-port <span class=nv>$REDIR_PORT</span> --tproxy-mark <span class=nv>$MARK_ID</span>

<span class=c1># REDIRECT</span>
iptables -t mangle -A PREROUTING -j clash
</code></pre></td></tr></table>
</div>
</div><p>参考：</p>
<ul>
<li><a test href=https://github.com/Dreamacro/clash/pull/1049>Add TCP TPROXY support</a></li>
<li><a test href=https://www.wogong.net/blog/2020/11/clash-transparent-proxy>Clash 作为网关的透明代理</a></li>
<li><a test href=https://guide.v2fly.org/app/tproxy.html>v2ray 透明代理(TPROXY)</a></li>
</ul>
<h3 id=tun>TUN</h3>
<p>适用于tun-redir,tun-fakeip，代理本机与外部流量。在iptables mangle中设置mark并过滤内部私有地址、过滤指定运行clash uid的流量防止循环。</p>
<p><del>本机docker内部网络无法直接被代理，如果不<code>-s 172.16.0.0/12 -j RETURN</code>则docker内部无法ping到外部网络，可能是在mangle表后路由到tun设备后无法被iptables nat中的DOCKER链处理。</del></p>
<p>使用<code>-i "$TUN_NAME" -j RETURN</code>防止docker内部流量被mark循环到tun接口。具体可行原因未知<code>todo</code> </p>
<div class=highlight><div class=chroma>
<table class=lntable><tr><td class=lntd>
<pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td>
<td class=lntd>
<pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=c1># 代理本机与外部流量。在iptables mangle中设置mark并过滤内部私有地址、</span>
<span class=c1># 过滤指定运行clash uid的流量防止循环。允许本机与docker通过代理</span>

<span class=c1>## 接管clash宿主机内部流量</span>
iptables -t mangle -N CLASH
iptables -t mangle -F CLASH
<span class=c1># filter clash traffic running under uid 注意顺序 owner过滤 要在 set mark之前</span>
iptables -t mangle -A CLASH -m owner --uid-owner <span class=s2>&#34;</span><span class=nv>$RUNNING_UID</span><span class=s2>&#34;</span> -j RETURN
<span class=c1># private</span>
local_iptables mangle CLASH
<span class=c1># mark</span>
iptables -t mangle -A CLASH -j MARK --set-xmark <span class=nv>$MARK_ID</span>

iptables -t mangle -A OUTPUT -j CLASH

<span class=c1>## 接管转发流量</span>
iptables -t mangle -N CLASH_EXTERNAL
iptables -t mangle -F CLASH_EXTERNAL
<span class=c1># private</span>
local_iptables mangle CLASH_EXTERNAL
<span class=c1># avoid rerouting for local docker</span>
iptables -t mangle -A CLASH_EXTERNAL -i <span class=s2>&#34;</span><span class=nv>$TUN_NAME</span><span class=s2>&#34;</span> -j RETURN
<span class=c1># mark</span>
iptables -t mangle -A CLASH_EXTERNAL -j MARK --set-xmark <span class=nv>$MARK_ID</span>

iptables -t mangle -A PREROUTING -j CLASH_EXTERNAL

<span class=c1># utun route table</span>
ip route replace default dev <span class=s2>&#34;</span><span class=nv>$TUN_NAME</span><span class=s2>&#34;</span> table <span class=s2>&#34;</span><span class=nv>$TABLE_ID</span><span class=s2>&#34;</span>
ip rule add fwmark <span class=s2>&#34;</span><span class=nv>$MARK_ID</span><span class=s2>&#34;</span> lookup <span class=s2>&#34;</span><span class=nv>$TABLE_ID</span><span class=s2>&#34;</span>

<span class=c1># 排除 rp_filter 的故障 反向路由</span>
sysctl -w net.ipv4.conf.<span class=s2>&#34;</span><span class=nv>$TUN_NAME</span><span class=s2>&#34;</span>.rp_filter<span class=o>=</span><span class=m>0</span> 2&gt; /dev/null
sysctl -w net.ipv4.conf.all.rp_filter<span class=o>=</span><span class=m>0</span> 2&gt; /dev/null
</code></pre></td></tr></table>
</div>
</div><p>参考：</p>
<ul>
<li><a test href=https://comzyh.gitbook.io/clash/real-ip-tun-example>Real-IP Tun Example</a></li>
<li><a test href=https://lancellc.gitbook.io/clash/start-clash/clash-tun-mode>Clash TUN mode</a></li>
</ul>
<h3 id=已知问题>已知问题</h3>
<ol>
<li>TPROXY 不能用于 OUTPUT 链，无法用于本机代理。在<a test href=https://guide.v2fly.org/app/tproxy.html#%E9%85%8D%E7%BD%AE%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86%E8%A7%84%E5%88%99>v2ray 配置透明代理规则</a>中可以通过标记重路由的方式代理本机，但是在clash要对clash源码在socket上标记<code>SO_MARK</code>。查看了openclash源码也没有对<code>UDP TPROXY</code>的解决方法，在使用TPROXY时只能代理本机tcp流量。尝试使用<code>--owner-uid</code>的方式过滤clash发出的流量，但是没有用，可能是与OUTPUT重路由到PREROUTING链不同，原理不清</li>
<li><del>TUN方式在docker使用时bridge网络无法解析dns到外部网络，<a test href=https://github.com/springzfx/cgproxy/issues/10>容器(docker)桥接(bridge)模式时的代理问题</a>有相关讨论。fakeip直接启动时不设置只是作为dns网关使用时，docker bridge网络可以正常使用。<code>TCP TPROXY</code>的方式可以bridge网络可正常使用</del></li>
</ol>
<p>shell实现参考：</p>
<ul>
<li><a test href=https://github.com/juewuy/ShellClash/blob/master/scripts/start.sh>shellclash start.sh</a></li>
<li><a test href=https://github.com/vernesong/OpenClash/blob/master/luci-app-openclash/root/etc/init.d/openclash>OpenClash openclash</a></li>
<li><a test href=https://github.com/Kr328/clash-premium-installer/blob/master/scripts/setup-tun.sh>clash-premium-installer setup-tun.sh</a></li>
</ul>
<p>参考：</p>
<ul>
<li><a test href=https://stackoverflow.com/a/17538964>How to check if a variable is set in Bash?</a></li>
<li><a test href=https://github.com/Kr328/clash-premium-installer>Clash Premiun Installer</a></li>
<li><a test href=https://segmentfault.com/a/1190000022971054>你的 docker stop，它优雅吗？</a></li>
<li><a test href=https://stackoverflow.com/a/60699262>Unable to trap signals in docker entrypoint script</a></li>
<li><a test href=https://www.cnblogs.com/bakari/p/10449664.html>Linux 网络工具详解之 ip tuntap 和 tunctl 创建 tap/tun 设备</a></li>
<li><a test href=https://github.com/juewuy/ShellClash>ShellClash</a></li>
<li><a test href=https://blog.skk.moe/post/what-happend-to-dns-in-proxy/>浅谈在代理环境中的 DNS 解析行为</a></li>
<li><a test href=https://github.com/springzfx/cgproxy/issues/10>容器(docker)桥接(bridge)模式时的代理问题</a></li>
<li><a test href=https://github.com/springzfx/cgproxy/blob/aaa628a76b2911018fc93b2e3276c177e85e0861/readme.md#known-issues>Transparent Proxy powered by cgroup v2</a></li>
</ul>
<p>相关项目：</p>
<ul>
<li><a test href=https://github.com/Dreamacro/clash>go Dreamacro/clash</a></li>
<li><a test href=https://github.com/comzyh/clash>go tun comzyh/clash</a></li>
<li><a test href=https://github.com/lazytiger/trojan-rs>rust Trojan-rs</a></li>
</ul>
</div>
</article>
</div>
</div>
</main>
<footer id=footer class=footer>
<div class=social-links>
<a href=https://github.com/NavyD/navyd.github.io class="iconfont icon-github" title=github></a>
<a href=https://navyd.github.io/index.xml type=application/rss+xml class="iconfont icon-rss" title=rss></a>
</div>
<div class=copyright>
<span class=power-by>
由 <a class=hexo-link href=https://gohugo.io>Hugo</a> 强力驱动
</span>
<span class=division>|</span>
<span class=theme-info>
主题 -
<a class=theme-link href=https://github.com/olOwOlo/hugo-theme-even>Even</a>
</span>
<span class=copyright-year>
&copy;
2021<span class=heart><i class="iconfont icon-heart"></i></span><span>navyd</span>
</span>
</div>
</footer>
<div class=back-to-top id=back-to-top>
<i class="iconfont icon-up"></i>
</div>
</div>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.min.js integrity="sha256-jwCP0NAdCBloaIWTWHmW4i3snUNMHUNO+jr9rYd2iOI=" crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/timeago.js@3.0.2/dist/timeago.locales.min.js integrity="sha256-ZwofwC1Lf/faQCzN7nZtfijVV6hSwxjQMwXL4gn9qU8=" crossorigin=anonymous></script>
<script>var languageCode="en".replace(/-/g,'_').replace(/_(.*)/,function(b,a){return b.replace(a,a.toUpperCase())});timeago().render(document.querySelectorAll('.timeago'),languageCode),timeago.cancel()</script>
<script type=text/javascript src=/js/main.min.c99b103c33d1539acf3025e1913697534542c4a5aa5af0ccc20475ed2863603b.js></script>
</body>
</html>